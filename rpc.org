#+TITLE: discord RPC for zathura
#+AUTHOR: polarbear
#+EMAIL: 71zenith@proton.me

[[file:preview.png]]

** only proceed if u don't mind severe autism

- requires =pypresence=
- for thumbnails, use this [[https://github.com/marianosimone/epub-thumbnailer][epub]] and [[https://imagemagick.org/index.php][pdf]]
- if it doesn't work, then it doesn't :pepeshrug:

#+begin_src python :tangle main.py :shebang "#!/usr/bin/env python3"
from pypresence import Presence
import os
import re
import requests
import subprocess
import time

start_time = None
old_path = None

RPC = Presence("1081997908985008138")
RPC.connect()

while True:
    try:
        pid = subprocess.check_output(['pidof', 'zathura'], text=True).split()[0]
    except subprocess.CalledProcessError:
        start_time = None
        RPC.clear()
        time.sleep(10)
        continue

    if start_time is None:
        start_time = time.time()

    output = subprocess.check_output(['gdbus', 'introspect', '--session', '--dest', f'org.pwmt.zathura.PID-{pid}', '--object-path', '/org/pwmt/zathura', '-p'], text=True)
    path = re.search(r"(['\"])(/.*?)(\1)", output)[0].strip("'").strip('"')
    lineno = re.findall(r"pagenumber = ([0-9]*)", output)[0]
    totalln = re.findall(r"numberofpages = ([0-9]*)", output)[0]

    filename = os.path.splitext(os.path.basename(path))[0].split(" - ")[0]
    directory = os.path.dirname(path)

    line_info = f"Page {lineno} of {totalln}"

    # comment this codeblock if u dont want to autogenerate covers (requires imagemagick, ghostscript, epub-thumbnailer)
    if not os.path.exists(f"{directory}/cover.jpg"):
        if path.endswith(".pdf"):
            subprocess.run(['convert', '-thumbnail', '500' , f"{path}[0]", f"{directory}/cover.jpg"], stderr = subprocess.PIPE)
        elif path.endswith(".epub") :
            subprocess.run(['epub-thumbnailer' , path , f"{directory}/cover.jpg" , '1024'], stderr = subprocess.PIPE)

    if os.path.exists(f"{directory}/cover.jpg"):
        if path != old_path:
            with open(f"{directory}/cover.jpg", 'rb') as f:
                image = {'file': ('cover.jpg', f, 'image/jpeg')}
                link = requests.post("https://0x0.st/", files=image).text.strip()
    else:
        link = "zathura"

    RPC.update(
        large_image = link,
        large_text = "checkmate adobe plebs",
        start = start_time,
        details = filename,
        state = line_info,
    )

    old_path = path

    time.sleep(10)
#+end_src
