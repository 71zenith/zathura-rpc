#+TITLE: discord RPC for zathura
#+AUTHOR: polarbear
#+EMAIL: 71zenith@proton.me

[[file:preview.png]]

** only proceed if u don't mind severe autism

- requires =pypresence=
- runs independently
- will check for =zathura= every 10 seconds
- if it doesn't work, then it doesn't :pepeshrug:

#+begin_src python :tangle main.py :shebang "#!/usr/bin/env python3"

from pypresence import Presence
import time
import subprocess
import re
import requests

url = 'https://0x0.st/'
RPC = Presence("1081997908985008138")

while True:
    try:
        RPC.connect()
        break
    except:
        time.sleep(10)
        continue

while True:
    try:
        pid = subprocess.check_output(['pidof', 'zathura']).decode().split()[0]
    except subprocess.CalledProcessError:
        if 'start' in locals():
            del start
        RPC.clear()
        time.sleep(10)
        continue

    if 'start' not in locals():
        start = time.time()

    output = subprocess.check_output(['gdbus', 'introspect', '--session', '--dest', f'org.pwmt.zathura.PID-{pid}', '--object-path', '/org/pwmt/zathura', '-p']).decode()
    path = re.search(r"(['\"])(/.*?)(\1)", output)[0].strip("'").strip('"')
    lineno = re.findall(r"pagenumber = ([0-9]*)", output)[0]
    totalln = re.findall(r"numberofpages = ([0-9]*)", output)[0]

    # uncomment the next line and remove the one after that (only for personal use)
    # filename = re.findall(r'[^\/]+(?=\.)',path)[0]
    filename = re.findall(r'[^\/]+(?=\.)',path)[0]
    directory = re.findall(r'^(.+/)',path)[0]
    line_info = (f"Page {lineno} of {totalln}")

    # remove this if statement (only for personal use)
    # or put a cover.jpg containing thumbnail in the directory where the file is
    if 'path' != 'old_path':
        with open(f"{directory}cover.jpg", 'rb') as f:
            image = {'file': ('cover.jpg', f, 'image/jpeg')}
            link = requests.post(url, files=image).text.strip()

    old_path = path

    RPC.update(
        large_image = link,
        large_text = "checkmate adobe plebs",
        start = start,
        details = filename,
        state = line_info,
    )
    time.sleep(10)
#+end_src
