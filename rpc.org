#+TITLE: zathura rpc
#+AUTHOR: polarbear
#+EMAIL: 71zenith@proton.me

* only proceed if u don't mind severe autism

- requires =pypresence=
- runs independently
- will check for =zathura= every 15 seconds

#+begin_src python :tangle main.py :shebang "#!/usr/bin/env python3"

from pypresence import Presence
import time
import subprocess
import re

start = time.time()
client_id = "1081997908985008138"

RPC = Presence(client_id)
RPC.connect()

while True:
    try:
        pid = subprocess.check_output(['pidof', 'zathura']).decode().split()[0]
    except subprocess.CalledProcessError:
        RPC.clear()
        time.sleep(15)
        continue

    output = subprocess.check_output(['gdbus', 'introspect', '--session', '--dest', f'org.pwmt.zathura.PID-{pid}', '--object-path', '/org/pwmt/zathura', '-p']).decode()

    filename = re.findall(r"filename = '([^']*)'", output)[0]
    lineno = re.findall(r"pagenumber = ([0-9]*)", output)[0]
    totalln = re.findall(r"numberofpages = ([0-9]*)", output)[0]

    # uncomment the next line and remove the one after that
    # filename = re.findall(r'[^\/]+(?=\.)',filename)[0]
    filename = re.findall(r'[^\/]+(?=\ - )',filename)[0]
    line_info = (f"Page {lineno} of {totalln}")

    RPC.update(
        large_image = "zathura",
        large_text = "checkmate adobe plebs",
        small_image = "weeb",
        small_text = "yes, im a weeb",
        start = start,
        details = filename,
        state = line_info,
    )
    time.sleep(15)
#+end_src
